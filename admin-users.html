<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Users — BiTForeX Academy</title>
<link rel="stylesheet" href="style.css">

<style>
/* --- Card Layout --- */
.user-card {
  background: rgba(255,255,255,0.04);
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 14px;
  border: 1px solid rgba(255,255,255,0.08);
}

.user-card h3 {
  margin: 0 0 6px;
  font-size: 18px;
  font-weight: 600;
}

.user-card .muted {
  font-size: 13px;
  margin-bottom: 8px;
}

.user-badge {
  display: inline-block;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 8px;
  margin-top: 6px;
  cursor: pointer;
}

.badge-active { background:#0f0;color:#000; }
.badge-inactive { background:#999;color:#000; }

.filter-bar {
  display: flex;
  gap: 8px;
  margin: 15px 0;
}

.filter-btn {
  padding: 6px 14px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.2);
  background: transparent;
  color: #fff;
  font-size: 14px;
}

.filter-btn.active {
  background: #0f0;
  color: #000;
  font-weight: bold;
}

.view-btn, .msg-btn {
  margin-top: 10px;
  padding: 6px 12px;
  border-radius: 6px;
  background: #0f0;
  color: #000;
  font-size: 14px;
  display: inline-block;
  border: none;
  cursor: pointer;
}
</style>

</head>

<body class="page-admin">

<header class="navbar">
  <div class="brand">
    <div class="logo-circle"><img src="logo.jpg" alt="logo"></div>
    <a class="logo-text">BiTForeX Admin</a>
  </div>

  <nav class="nav" id="main-nav">
    <a href="admin.html">Dashboard</a>
    <a href="admin-users.html" class="active">Users</a>
    <a href="admin-payments.html">Payments</a>
    <a href="admin-subscription-settings.html">Subscription Settings</a>
    <a href="admin-chat.html">Chat Inbox</a>
    <a href="admin-profile.html">Profile</a>
    <a href="login.html" id="logout-admin">Logout</a>
  </nav>

  <div id="menu-toggle" class="menu-toggle">☰</div>
</header>

<main class="container fade-in-up" style="margin-top:90px;">

  <h2>Registered Users</h2>
  <p class="muted">All users on your platform</p>

  <!-- FILTER BUTTONS -->
  <div class="filter-bar">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="Active">Active</button>
    <button class="filter-btn" data-filter="Inactive">Inactive</button>
  </div>

  <!-- USERS OUTPUT -->
  <div id="adminUsersTable" style="margin-top:10px;">
    <p class="muted">Loading users...</p>
  </div>

</main>

<footer class="site-footer">
  <p>© <span id="yr"></span> BiTForeX Admin</p>
</footer>

<!-- Firebase & App -->
<script type="module" src="firebase.js"></script>
<script type="module">
import { db, auth } from "./firebase.js";
import { collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const box = document.getElementById("adminUsersTable");
const filterBtns = document.querySelectorAll(".filter-btn");

async function loadUsers(filter = "all") {
  box.innerHTML = `<p class="muted">Loading users...</p>`;

  try {
    const querySnap = await getDocs(collection(db, "users"));
    const users = [];
    querySnap.forEach(docSnap => users.push({ uid: docSnap.id, ...docSnap.data() }));

    if (!users.length) {
      box.innerHTML = `<p class="muted">No users found.</p>`;
      return;
    }

    box.innerHTML = "";

    users
      .filter(u => {
        if (filter === "all") return true;
        return (u.active ? "Active" : "Inactive") === filter;
      })
      .forEach(u => {
        const statusClass = u.active ? "badge-active" : "badge-inactive";
        const sub = u.subscription?.plan || "None";

        const card = document.createElement("div");
        card.className = "user-card";

        card.innerHTML = `
          <h3>${u.username || u.email}</h3>
          <div class="muted">${u.email}</div>
          <p><strong>Plan:</strong> ${sub}</p>
          <span class="user-badge ${statusClass}" data-uid="${u.uid}">
            ${u.subscription?.plan ? "Subscribed" : "No Subscription"}
          </span>
          <br>
          <button class="view-btn">View User</button>
          <button class="msg-btn">Message</button>
        `;

        // VIEW USER modal
        card.querySelector(".view-btn").onclick = () => openUserModal(u);

        // MESSAGE button
        card.querySelector(".msg-btn").onclick = () => openChat(u.uid, u.username);

        // Subscription badge toggle
        const badge = card.querySelector(".user-badge");
        badge.onclick = async () => {
          const newSub = u.subscription?.plan ? null : { plan: "Custom" };
          await updateDoc(doc(db, "users", u.uid), { subscription: newSub });
          loadUsers(filter); // reload after update
        };

        box.appendChild(card);
      });

  } catch (err) {
    console.error(err);
    box.innerHTML = `<p class="muted">Failed to load users.</p>`;
  }
}

// VIEW USER MODAL
function openUserModal(user) {
  const overlay = document.createElement("div");
  overlay.style = `
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;
  `;

  const modal = document.createElement("div");
  modal.style = `
    background:#020617;padding:20px;border-radius:12px;max-width:400px;width:90%;
    color:#fff;
  `;
  modal.innerHTML = `
    <h3>${user.username || user.email}</h3>
    <p><strong>Email:</strong> ${user.email}</p>
    <p><strong>Subscription:</strong> ${user.subscription?.plan || "None"}</p>
    <p><strong>Status:</strong> ${user.active ? "Active" : "Inactive"}</p>
    <button id="msg-user-btn">Message User</button>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  modal.querySelector("#msg-user-btn").onclick = () => {
    openChat(user.uid, user.username);
    document.body.removeChild(overlay);
  };

  overlay.onclick = e => {
    if (e.target === overlay) document.body.removeChild(overlay);
  };
}

// FILTER BUTTONS
filterBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    filterBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const filter = btn.dataset.filter === "all" ? "all" : btn.dataset.filter;
    loadUsers(filter);
  });
});

// Initial load
onAuthStateChanged(auth, user => {
  if (user) loadUsers();
});
</script>

</body>
</html>